<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½ç‰©è”ç»¼åˆç®¡ç†å¹³å°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    :root {
      --sidebar-width: 240px;
      --header-height: 60px;
      --primary-color: #1890ff;
    }

    body {
      background-color: #f0f2f5;
      font-family: "Segoe UI", Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      width: var(--sidebar-width);
      background: #001529;
      color: #fff;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      box-shadow: 2px 0 6px rgba(0, 21, 41, 0.35);
      z-index: 10;
    }

    .logo-box {
      height: var(--header-height);
      display: flex;
      align-items: center;
      padding-left: 20px;
      font-size: 18px;
      font-weight: bold;
      background: #002140;
      letter-spacing: 1px;
    }

    .menu-item {
      padding: 14px 24px;
      color: rgba(255, 255, 255, 0.65);
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: flex;
      align-items: center;
    }

    .menu-item:hover,
    .menu-item.active {
      color: #fff;
      background-color: var(--primary-color);
    }

    .menu-item i {
      margin-right: 10px;
      font-size: 16px;
    }

    /* ä¸»ä½“ */
    .main-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      height: var(--header-height);
      background: #fff;
      box-shadow: 0 1px 4px rgba(0, 21, 41, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 5;
    }

    .content-body {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px;
    }

    .stat-card {
      background: #fff;
      padding: 20px 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
      border-top: 3px solid transparent;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-text h4 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }

    /* å¸ƒå±€ */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 24px;
      flex: 1;
      min-height: 0;
    }

    .panel {
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 16px 24px;
      border-bottom: 1px solid #f0f0f0;
      font-weight: 600;
      font-size: 16px;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* è®¾å¤‡å¡ç‰‡åŒº */
    .device-grid-container {
      padding: 24px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      align-content: start;
    }

    .device-card {
      border: 1px solid #e8e8e8;
      border-radius: 6px;
      padding: 20px;
      background: #fff;
      transition: all 0.3s;
      position: relative;
    }

    .device-card:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .device-status-badge {
      position: absolute;
      top: 15px;
      left: 15px;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      z-index: 5;
    }

    /* ç¦»çº¿è®¾å¤‡æ ·å¼ */
    .device-offline {
      filter: grayscale(100%);
      opacity: 0.8;
      border-color: #eee;
      background-color: #fafafa;
    }

    .device-offline:hover {
      transform: none;
      box-shadow: none;
      border-color: #eee;
    }

    /* æ—¥å¿— */
    .log-container {
      flex: 1;
      padding: 0 20px 20px 20px;
      overflow-y: auto;
    }

    .timeline {
      position: relative;
      padding-left: 20px;
      margin-top: 15px;
      border-left: 2px solid #e8e8e8;
    }

    .timeline-item {
      position: relative;
      margin-bottom: 20px;
      padding-left: 15px;
    }

    .timeline-dot {
      position: absolute;
      left: -26px;
      top: 5px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #ccc;
    }

    .timeline-time {
      font-size: 12px;
      color: #999;
      margin-bottom: 4px;
    }

    .timeline-content {
      font-size: 13px;
      color: #333;
      line-height: 1.4;
      background: #fafafa;
      padding: 8px 12px;
      border-radius: 4px;
      word-break: break-all;
    }

    .dot-success {
      border-color: #52c41a;
      background: #52c41a;
    }

    .dot-danger {
      border-color: #ff4d4f;
      background: #ff4d4f;
    }

    .dot-primary {
      border-color: #1890ff;
      background: #1890ff;
    }

    /* å›¾ç‰‡åˆ—æ ·å¼ */
    .user-avatar {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
  </style>
</head>

<body>

  <div class="sidebar">
    <div class="logo-box"><i class="bi bi-layers-fill me-2"></i> ç‰©è”ç®¡ç†å¹³å°</div>
    <div class="mt-2">
      <a href="/" class="menu-item active"><i class="bi bi-grid-fill"></i> è®¾å¤‡ç›‘æ§ä¸­å¿ƒ</a>
      <a href="#" class="menu-item" onclick="alert('è‡ªåŠ¨åŒæ­¥å·²åœ¨åå°è¿è¡Œ')"><i class="bi bi-database-fill-gear"></i> æ•°æ®åŒæ­¥ç®¡ç†</a>
      <a href="/history" class="menu-item"><i class="bi bi-file-earmark-text-fill"></i> é€šè¡Œè®°å½•æŠ¥è¡¨</a>
      <a href="#" class="menu-item"><i class="bi bi-gear-fill"></i> ç³»ç»Ÿå‚æ•°è®¾ç½®</a>
    </div>
  </div>

  <div class="main-wrapper">
    <div class="header">
      <div class="text-secondary"><i class="bi bi-list fs-4 cursor-pointer"></i></div>
      <div class="d-flex align-items-center">
        <span class="badge rounded-pill bg-primary me-3 px-3 py-2">ç³»ç»Ÿè¿è¡Œæ­£å¸¸</span>
        <span class="ms-2 fw-bold text-secondary" style="font-size: 14px;">ç®¡ç†å‘˜</span>
        <a href="/logout" class="ms-3 btn btn-outline-secondary btn-sm" style="font-size: 12px;"><i
            class="bi bi-box-arrow-right"></i> é€€å‡º</a>
      </div>
    </div>

    <div class="content-body">
      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="stats-row">
        <div class="stat-card" style="border-top-color: #1890ff;">
          <div class="stat-text"><span>æ¥å…¥è®¾å¤‡</span>
            <h4>{{ count }}</h4>
          </div>
          <div class="stat-icon" style="background: #e6f7ff; color: #1890ff;"><i class="bi bi-router"></i></div>
        </div>
        <div class="stat-card" style="border-top-color: #52c41a;">
          <div class="stat-text"><span>åœ¨çº¿è®¾å¤‡</span>
            <h4>{{ online_count }}</h4>
          </div>
          <div class="stat-icon" style="background: #f6ffed; color: #52c41a;"><i class="bi bi-check-circle"></i></div>
        </div>
        <div class="stat-card" style="border-top-color: #ff4d4f;">
          <div class="stat-text"><span>ç¦»çº¿/å¼‚å¸¸</span>
            <h4>{{ offline_count }}</h4>
          </div>
          <div class="stat-icon" style="background: #fff1f0; color: #ff4d4f;"><i class="bi bi-x-circle"></i></div>
        </div>
        <div class="stat-card" style="border-top-color: #faad14;">
          <div class="stat-text"><span>å¾…å¤„ç†ä»»åŠ¡</span>
            <h4>{{ task_count }}</h4>
          </div>
          <div class="stat-icon" style="background: #fffbe6; color: #faad14;"><i class="bi bi-list-task"></i></div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="panel">
          <div class="panel-header">
            <span><i class="bi bi-hdd-network me-2 text-primary"></i>è®¾å¤‡åˆ—è¡¨</span>
            <span class="badge bg-light text-dark border">{{ count }} å°</span>
          </div>
          <div class="device-grid-container">
            {% for sn, info in devices.items() %}
            <!-- æ ¹æ®çŠ¶æ€æ·»åŠ  device-offline ç±» -->
            <div class="device-card position-relative {% if info.status == 'offline' %}device-offline{% endif %}">

              <!-- çŠ¶æ€æ ‡ç­¾ -->
              {% if info.status == 'online' %}
              <div class="device-status-badge bg-success-light text-success border border-success border-opacity-25">
                <i class="bi bi-wifi"></i> åœ¨çº¿
              </div>
              {% else %}
              <div class="device-status-badge bg-secondary text-white border">
                <i class="bi bi-wifi-off"></i> ç¦»çº¿
              </div>
              {% endif %}

              <!-- å½»åº•ç§»é™¤æŒ‰é’® -->
              <i class="bi bi-x-circle-fill text-danger position-absolute top-0 end-0 m-3 fs-5 btn-remove-device"
                style="cursor: pointer; z-index: 10; transition: 0.2s;" onclick="removeDevice('{{ sn }}')"
                title="ä»åˆ—è¡¨ä¸­å½»åº•ç§»é™¤æ­¤è®¾å¤‡"></i>

              <!-- è®¾å¤‡ä¿¡æ¯ -->
              <div class="text-center mt-3 mb-3">
                <i class="bi bi-display text-secondary d-block mb-2" style="font-size: 3rem;"></i>
                <div class="fw-bold text-dark" style="font-size: 1.4rem; letter-spacing: 1px;">{{ sn }}</div>
                <div class="text-muted small bg-light d-inline-block px-2 rounded border mt-1">IP: {{ info.ip }}</div>
              </div>

              <div class="bg-light p-2 rounded mb-3 text-secondary small text-center">
                <div><i class="bi bi-clock me-1"></i>æœ€åå¿ƒè·³: {{ info.last_seen }}</div>
              </div>

              <div class="d-grid gap-2">
                <button class="btn btn-warning btn-sm text-dark fw-bold" onclick="syncFromDatabase('{{ sn }}')">
                  <i class="bi bi-database-fill-up"></i> ä»å‘˜å·¥åº“åŒæ­¥
                </button>
                <div class="btn-group">
                  <button class="btn btn-primary btn-sm" onclick="openAddModal('{{ sn }}')">
                    <i class="bi bi-person-plus"></i> ä¸‹å‘
                  </button>
                  <button class="btn btn-info btn-sm text-white" onclick="openUserListModal('{{ sn }}')">
                    <i class="bi bi-list-ul"></i> åå•
                  </button>
                </div>
                <button class="btn btn-outline-danger btn-sm" onclick="openDelModal('{{ sn }}')">
                  <i class="bi bi-person-dash"></i> åˆ é™¤äººå‘˜
                </button>
              </div>
            </div>
            {% else %}
            <div class="text-center w-100 py-5 text-muted">
              <div class="spinner-grow text-primary mb-3"></div>
              <p>ç­‰å¾…è®¾å¤‡æ¥å…¥ä¸­...</p>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="panel">
          <div class="panel-header"><span><i class="bi bi-clock-history me-2 text-warning"></i>å®æ—¶å®¡è®¡æ—¥å¿—</span></div>
          <div class="log-container" id="logPanel">
            <div class="timeline" id="logTimeline">
              {% for log in logs %}
              <div class="timeline-item">
                {% if 'âœ…' in log %}
                <div class="timeline-dot dot-success"></div>
                {% elif 'âŒ' in log or 'âš ï¸' in log or 'ğŸ”¥' in log %}
                <div class="timeline-dot dot-danger"></div>
                {% else %}
                <div class="timeline-dot dot-primary"></div>
                {% endif %}

                {% if ']' in log %}
                <div class="timeline-time">{{ log.split(']')[0].replace('[', '') }}</div>
                <div class="timeline-content text-break">{{ log.split(']', 1)[1] }}</div>
                {% else %}
                <div class="timeline-time">System</div>
                <div class="timeline-content text-break">{{ log }}</div>
                {% endif %}
              </div>
              {% else %}<p class="text-center text-muted mt-4">æš‚æ— æ—¥å¿—</p>{% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¼¹çª—ï¼šä¸‹å‘äººå‘˜ -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ä¸‹å‘äººå‘˜</h5><button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="target_sn">
          <div class="mb-3"><label>å§“å</label><input type="text" class="form-control" id="add_name" required></div>
          <div class="mb-3"><label>å·¥å·</label><input type="text" class="form-control" id="add_uid" required></div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">å¡å· (Card ID)</label>
              <input type="text" class="form-control" id="add_card_id" placeholder="é€‰å¡«">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">å¯†ç  (Password)</label>
              <input type="text" class="form-control" id="add_password" placeholder="é€‰å¡«">
            </div>
          </div>

          <div class="mb-3"><label>ç…§ç‰‡ (å¿…éœ€)</label><input type="file" class="form-control" id="add_photo"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" onclick="submitAdd()">ç¡®è®¤ä¸‹å‘</button></div>
      </div>
    </div>
  </div>

  <!-- å¼¹çª—ï¼šåˆ é™¤äººå‘˜ -->
  <div class="modal fade" id="delModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">åˆ é™¤äººå‘˜</h5><button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"><input type="hidden" id="del_target_sn">
          <div class="mb-3"><label>å·¥å·</label><input type="text" class="form-control" id="del_uid"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-danger" onclick="submitDel()">åˆ é™¤</button></div>
      </div>
    </div>
  </div>

  <!-- å¼¹çª—ï¼šäººå‘˜åå• (å¸¦ç…§ç‰‡) -->
  <div class="modal fade" id="userListModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">è®¾å¤‡äººå‘˜åå•</h5><button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0"><input type="hidden" id="list_target_sn">
          <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-light sticky-top">
              <tr>
                <th class="ps-4">å·¥å·</th>
                <th>ç…§ç‰‡</th>
                <th>å§“å</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="user_list_body"></tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // è‡ªåŠ¨åˆ·æ–°é€»è¾‘ï¼šæ¯5ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œä½†å¦‚æœæœ‰å¼¹çª—æ‰“å¼€ï¼Œåˆ™æš‚åœåˆ·æ–°
    let refreshTimer = null;
    function startRefresh () {
      if (!refreshTimer) {
        refreshTimer = setTimeout(function () { window.location.reload(); }, 5000);
      }
    }
    function stopRefresh () {
      if (refreshTimer) { clearTimeout(refreshTimer); refreshTimer = null; }
    }
    startRefresh();

    document.querySelectorAll('.modal').forEach(m => {
      m.addEventListener('show.bs.modal', stopRefresh);
      m.addEventListener('hidden.bs.modal', startRefresh);
    });

    // åˆå§‹åŒ–å¼¹çª—å¯¹è±¡
    const addModal = new bootstrap.Modal(document.getElementById('addModal'));
    const delModal = new bootstrap.Modal(document.getElementById('delModal'));
    const userListModal = new bootstrap.Modal(document.getElementById('userListModal'));

    function openAddModal (sn) {
      document.getElementById('target_sn').value = sn;
      document.getElementById('add_name').value = '';
      document.getElementById('add_uid').value = '';
      document.getElementById('add_card_id').value = '';
      document.getElementById('add_password').value = '';
      document.getElementById('add_photo').value = '';
      addModal.show();
    }

    function openDelModal (sn) { document.getElementById('del_target_sn').value = sn; delModal.show(); }

    // æ‰“å¼€åå•ï¼Œå¹¶åŠ è½½æ•°æ®
    function openUserListModal (sn) {
      document.getElementById('list_target_sn').value = sn;
      const tbody = document.getElementById('user_list_body');
      tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">æ­£åœ¨ä»è®¾å¤‡è·å–åå•å’Œç…§ç‰‡...</p></td></tr>';

      userListModal.show();

      fetch(`/api/query_users?sn=${sn}`)
        .then(r => r.json())
        .then(d => {
          tbody.innerHTML = '';
          if (d.code !== 0 || !d.data || d.data.length === 0) {
            return tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted">${d.msg || 'æš‚æ— äººå‘˜æ•°æ®'}</td></tr>`;
          }

          d.data.forEach(u => {
            // å¤„ç†å›¾ç‰‡Base64
            let imgHtml = '<span class="text-muted small">æ— ç…§ç‰‡</span>';
            if (u.img && u.img.length > 50) {
              // æœ‰äº›è®¾å¤‡è¿”å›æ—¶ä¸å¸¦å‰ç¼€ï¼ŒåŠ ä¸Šä¿é™©
              const src = u.img.startsWith('data:') ? u.img : 'data:image/jpeg;base64,' + u.img;
              imgHtml = `<img src="${src}" class="user-avatar" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾" onclick="window.open(this.src)">`;
            }

            tbody.innerHTML += `
                <tr>
                    <td class="ps-4 fw-bold text-dark">${u.uid}</td>
                    <td>${imgHtml}</td>
                    <td>${u.name}</td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="quickDel('${sn}','${u.uid}')">åˆ é™¤</button></td>
                </tr>`;
          });
        })
        .catch(e => {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-danger">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
        });
    }

    function removeDevice (sn) {
      event.stopPropagation();
      if (confirm(`ç¡®å®šä»åˆ—è¡¨ä¸­å½»åº•ç§»é™¤è®¾å¤‡ ${sn}?`)) fetch(`/api/remove_device?sn=${sn}`).then(r => r.json()).then(d => { if (d.code === 0) window.location.reload(); });
    }

    function syncFromDatabase (sn) {
      // å®é™…ä¸Šç›®å‰åå°æ²¡æœ‰è¿™ä¸ªæ¥å£ï¼Œè¿™é‡Œä»…ä½œæ¼”ç¤ºæˆ–æ ¹æ®ä½ ä¹‹å‰ä»£ç æ·»åŠ 
      alert("åŒæ­¥æŒ‡ä»¤å·²å‘é€åå°ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—é¢æ¿");
    }

    function submitAdd () {
      const sn = document.getElementById('target_sn').value;
      const name = document.getElementById('add_name').value;
      const uid = document.getElementById('add_uid').value;
      const card_id = document.getElementById('add_card_id').value;
      const password = document.getElementById('add_password').value;
      const f = document.getElementById('add_photo').files[0];

      if (!name || !uid || !f) return alert("è¯·å¡«å†™å§“åã€å·¥å·å¹¶é€‰æ‹©ç…§ç‰‡");

      const fd = new FormData();
      fd.append('sn', sn);
      fd.append('name', name);
      fd.append('uid', uid);
      fd.append('card_id', card_id);
      fd.append('password', password);
      fd.append('file', f);

      // æ˜¾ç¤ºLoadingçŠ¶æ€
      const btn = document.querySelector('#addModal .btn-primary');
      const originalText = btn.innerText;
      btn.innerText = 'ä¸‹å‘ä¸­...';
      btn.disabled = true;

      fetch('/api/add_user', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(d => {
          alert(d.msg);
          if (d.code === 0) {
            addModal.hide();
            window.location.reload();
          }
        })
        .finally(() => {
          btn.innerText = originalText;
          btn.disabled = false;
        });
    }

    function submitDel () {
      const sn = document.getElementById('del_target_sn').value, uid = document.getElementById('del_uid').value;
      if (!uid) return alert("å¡«å·¥å·");
      fetch(`/api/del_user?sn=${sn}&uid=${uid}`).then(r => r.json()).then(d => { alert(d.msg); if (d.code === 0) { delModal.hide(); window.location.reload(); } });
    }

    function quickDel (sn, uid) {
      if (confirm(`ç¡®å®šåˆ é™¤å·¥å· ${uid}?`)) fetch(`/api/del_user?sn=${sn}&uid=${uid}`).then(r => r.json()).then(d => { alert(d.msg); if (d.code === 0) openUserListModal(sn); });
    }
  </script>
</body>

</html>